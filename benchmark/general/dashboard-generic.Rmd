---
title: "Dashboard"
params:
  csv_path: "sts/log_20170412_174804_t.csv"
  timeout_ms: 600000
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
---

This is a benchmark report for the file `r params$csv_path`.

```{r setup, include = FALSE}
library(tidyverse)
library(stringr)
library(forcats)
library(lubridate)
library(flexdashboard)
# Themes
theme_rotate_x <- theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
theme_noticks <- theme(axis.ticks = element_blank())
gauge_sectors_percent <- function(min, max, warn, succ) {
  succ_absolute <- min + (max - min) * succ / 100
  warn_absolute <- min + (max - min) * warn / 100
  if (warn < succ) {
    gaugeSectors(
      success = c(succ_absolute, max),
      warning = c(warn_absolute, succ_absolute),
      danger = c(min, warn_absolute))
  } else {
    gaugeSectors(
      success = c(min, succ_absolute),
      warning = c(succ_absolute, warn_absolute),
      danger = c(warn_absolute, max))
  }
}
# Read data
d <- read_csv(
  params$csv_path,
  col_types = cols(
    Model = col_character(),
    Config = col_character(),
    Safe = col_character(),
    TimeMs = col_integer()
  )
)
# Convert 'Safe' to logical (removing exceptions and timeouts).
n_rows_empty <- sum(is.na(d$Safe))
d_exceptions <- d %>% filter(str_detect(d$Safe, "\\[EX\\]"))
n_rows_exception <- nrow(d_exceptions)
d$Safe <- as.logical(d$Safe)
# Calculate summary values
n_meas_rep_total <- nrow(d)
n_meas_rep_succ <- nrow(d %>% filter(!is.na(Safe)))
n_models_total <- length(unique(d$Model))
n_configs_total <- length(unique(d$Config))
n_meas_total <- n_models_total * n_configs_total
total_time <- seconds_to_period(sum(ifelse(is.na(d$TimeMs), params$timeout_ms, d$TimeMs)) / 1000)

d_model_config <- d %>%
  group_by(Config, Model) %>%
  summarise(
    ResultCount = sum(!is.na(Safe)),
    Succ = ResultCount > 0,
    SafeCount = sum(Safe, na.rm = T),
    Consistent = SafeCount == 0 || SafeCount == ResultCount,
    TimeAvg = mean(TimeMs),
    TimeRSD = ifelse(ResultCount == 1, 0, sd(TimeMs) / mean(TimeMs)))
d_model <- d_model_config %>% group_by(Model) %>%
  summarise(
    ResultCount = sum(ResultCount),
    Succ = ResultCount > 0,
    SafeCount = sum(SafeCount),
    Consistent = SafeCount == 0 || SafeCount == ResultCount,
    TimeMin = min(TimeAvg, na.rm = T),
    ConfigMin = ifelse(is.na(TimeMin), "", Config[which.min(TimeAvg)]))
d_model$ConfigMin[d_model$ConfigMin == ""] <- NA

n_models_succ <- length(unique((d_model %>% filter(Succ))$Model))
n_configs_succ <- length(unique((d_model_config %>% filter(Succ))$Config))
```

Overview
=====================================

Row
-------------------------------------
### Models
```{r}
valueBox(n_models_total, icon = "fa-files-o")
```

### Configurations
```{r}
valueBox(n_configs_total, icon = "fa-cogs")
```

### Measurements
```{r}
valueBox(n_meas_total, icon = "fa-tasks")
```

### Success rate
```{r}
gauge(nrow(d_model_config %>% filter(Succ)), min = 0, max = n_meas_total,
      gauge_sectors_percent(0, n_meas_total, 50, 75))
```

### Models verified (at least one config)
```{r}
gauge(n_models_succ, min = 0, max = n_models_total,
      gauge_sectors_percent(0, n_models_total, 50, 75))
```

Row
-------------------------------------
### Success rate (incl. repetitions)
```{r}
gauge(n_meas_rep_succ, min = 0, max = n_meas_rep_total,
      gauge_sectors_percent(0, n_meas_rep_total, 50, 75))
```

### Missing values & exceptions
```{r}
gauge(n_rows_empty + n_rows_exception, min = 0, max = n_meas_rep_total,
      gauge_sectors_percent(0, n_meas_rep_total, 10, 1))
```

### Total time
```{r}
valueBox(paste(total_time$day, "d ", total_time$hour, "h ", total_time$minute, "m", sep = ""), icon = "fa-clock-o")
```

### Timeout
```{r}
valueBox(paste(params$timeout_ms / 1000, "s", sep = ""), icon = "fa-clock-o")
```

### Maximum execution time
```{r}
gauge(max(d$TimeMs, na.rm = T) / 1000, min = 0, max = params$timeout_ms / 1000,
      gauge_sectors_percent(0, params$timeout_ms / 1000, 95, 90))
```


Row
-------------------------------------

### Consistency of configurations

There are **`r sum(!d_model_config$Consistent)`** cases where different executions of the same configuration yielded different results for the same model.

```{r}
if (sum(!d_model_config$Consistent) > 0) {
  knitr::kable(d_model_config %>% filter(!Consistent) %>% ungroup() %>% select(Config, Model))
}
```

### Consistency of models

There are **`r sum(!d_model$Consistent)`** cases where different executions of the same configuration or different configurations yielded different results for the same model.

```{r}
if (sum(!d_model$Consistent) > 0) {
  knitr::kable(d_model %>% filter(!Consistent) %>% select(Model, Consistent))
}
```

Row
-------------------------------------

### Exceptions

There are **`r n_rows_exception`** exceptions.

```{r}
if (n_rows_exception > 0) {
  knitr::kable(d_exceptions %>% group_by(Type = Safe) %>% summarise(Count = n()))
}
```

Succes rates
=====================================

```{r}
config_stats <- d_model_config  %>% group_by(Config) %>% summarise(N = sum(Succ))
model_stats <- d_model_config %>% group_by(Model) %>% summarise(N = sum(Succ))
```

Row
-------------------------------------

### Lowest success rate of a config
```{r}
gauge(min(config_stats$N), min = 0, max = n_models_total,
      gauge_sectors_percent(0, n_models_total, 50, 75))
```

### Highest success rate of a config
```{r}
gauge(max(config_stats$N), min = 0, max = n_models_total,
      gauge_sectors_percent(0, n_models_total, 50, 75))
```

### Lowest success rate of a model
```{r}
gauge(min(model_stats$N), min = 0, max = n_configs_total,
      gauge_sectors_percent(0, n_configs_total, 50, 75))
```

### Highest success rate of a model
```{r}
gauge(max(model_stats$N), min = 0, max = n_configs_total,
      gauge_sectors_percent(0, n_configs_total, 50, 75))
```

Row
-------------------------------------

### Number of configurations that verified a model
```{r}
ggplot(d_model_config) +
  geom_bar(aes(x = Model, fill = Succ)) +
  scale_x_discrete(drop = F) +
  theme_rotate_x
```

### Number of models verified by each configuration
```{r}
ggplot(d_model_config) +
  geom_bar(aes(x = Config, fill = Succ)) +
  scale_x_discrete(drop = F) +
  theme_rotate_x
```

Row
-------------------------------------

### Number of successful executions
```{r, fig.width=8}
ggplot(d_model_config, aes(Config, Model)) +
  geom_tile(aes(fill = ResultCount), color = "black") +
  scale_fill_gradient(low = "red", high = "green", na.value = "white") +
  theme_noticks + theme_rotate_x
```

Deviation of execution time
===================================== 

Row
-------------------------------------

### Maximum RSD
```{r}
gauge(round(max(d_model_config$TimeRSD, na.rm = T) * 100, 0), min = 0, max = 100,
      symbol = "%", gauge_sectors_percent(0, 100, 20, 10))
```

### Mean RSD
```{r}
gauge(round(mean(d_model_config$TimeRSD, na.rm = T) * 100, 0), min = 0, max = 100,
      symbol = "%", gauge_sectors_percent(0, 100, 10, 5))
```

Row
-------------------------------------

### Overall distribution of the RSD

```{r, fig.height = 2}
ggplot(d_model_config) +
  geom_histogram(aes(TimeRSD))
```

### Individual RSD for each configuration and model

```{r}
ggplot(d_model_config, aes(Config, Model)) +
  geom_tile(aes(fill = TimeRSD), color = "black") +
  scale_fill_gradient(low = "green", high = "red", na.value = "white") +
  theme_noticks + theme_rotate_x
```

Execution time
===================================== 

Row
-------------------------------------

### Distribution of execution time

```{r, fig.height = 3}
ggplot(d %>% filter(!is.na(TimeMs))) +
  geom_histogram(aes(TimeMs))
summary(d$TimeMs)
```

### Distribution of execution time for each model
```{r}
ggplot(d %>% filter(!is.na(TimeMs))) +
  geom_boxplot(aes(Model, log10(TimeMs))) + coord_flip()
```

Row
-------------------------------------

### Heatmap of execution time for each model/configuration
```{r}
ggplot(d_model_config, aes(Config, Model)) +
  geom_tile(aes(fill = log10(TimeAvg)), color = "black") +
  scale_fill_gradient(low = "green", high = "red", na.value = "white") +
  theme_noticks + theme_rotate_x
```

### Number of models where a configuration was the fastest
```{r}
ggplot(d_model %>% filter(!is.na(ConfigMin))) +
  geom_bar(aes(x = ConfigMin)) +
  theme_rotate_x
```